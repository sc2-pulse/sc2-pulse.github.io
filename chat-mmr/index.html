<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starcraft2 Nightbot MMR command generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ffcc00, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #ffcc00;
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        select {
            width: 200px;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }

        select option {
            background: #2a5298;
            color: #fff;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            transition: all 0.3s ease;
            user-select: none;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .checkbox-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .checkbox-item.drag-over {
            border: 2px dashed #ffcc00;
            background: rgba(255, 204, 0, 0.1);
        }

        .checkbox-item.drop-before::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            height: 4px;
            background: #ffcc00;
            border-radius: 2px;
            z-index: 1000;
        }

        .checkbox-item.drop-after::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -2px;
            right: -2px;
            height: 4px;
            background: #ffcc00;
            border-radius: 2px;
            z-index: 1000;
        }

        .checkbox-item {
            position: relative;
        }

        .drag-handle {
            margin-right: 10px;
            color: #999;
            cursor: move;
        }

        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #ffcc00;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex-grow: 1;
        }

        .output-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .output-section h3 {
            margin-bottom: 15px;
            color: #ffcc00;
            font-size: 1.3em;
        }

        .code-block {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #00ff00;
            position: relative;
            overflow-x: auto;
        }

        .output-preview {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #ffffff;
            position: relative;
            overflow-x: auto;
            min-height: 50px;
        }

        .output-preview.loading {
            color: #ffcc00;
            font-style: italic;
        }

        .output-preview.error {
            color: #ff4444;
            border-color: #ff4444;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #ff6b35;
            color: #fff;
        }

        .footer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .footer h3 {
            margin-bottom: 15px;
            color: #ffcc00;
        }

        .footer p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .warning::before {
            content: "⚠️ ";
            margin-right: 5px;
        }

        .error {
            color: #ff4444;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Starcraft2 Nightbot MMR Command Generator</h1>
        
        <div class="section">
            <h2>Main</h2>
            <div class="input-group">
                <label for="teamLegacyUids">teamLegacyUids from SC2Pulse:</label>
                <input type="text" id="teamLegacyUids" placeholder="Enter teamLegacyUids (comma-separated)" required pattern="^(\d+-\d+-\d+-[\d\.~]+)(,\d+-\d+-\d+-[\d\.~]+)*$" title="Please enter valid teamLegacyUids separated by commas">
                <div class="error" id="teamLegacyUidsError"></div>
            </div>
        </div>

        <div class="section">
            <h2>Data</h2>
            <p style="margin-bottom: 15px; color: #ccc;">Drag and drop to reorder options:</p>
            <div class="checkbox-grid" id="dataOptions">
                <div class="checkbox-item" draggable="true" data-option="inGameName">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="inGameName" checked>
                    <label for="inGameName">In-game name</label>
                    <input type="checkbox" id="race" checked style="margin-left: 15px;">
                    <label for="race" style="margin-left: 5px;">Race</label>
                </div>
                <div class="checkbox-item" draggable="true" data-option="mmr">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="mmr" checked>
                    <label for="mmr">MMR</label>
                </div>
                <div class="checkbox-item" draggable="true" data-option="topPercent">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="topPercent">
                    <label for="topPercent">Top%</label>
                </div>
                <div class="checkbox-item" draggable="true" data-option="mode">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="mode">
                    <label for="mode">Mode(1v1, 2v2, etc.)</label>
                </div>
                <div class="checkbox-item" draggable="true" data-option="region">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="region">
                    <label for="region">Region</label>
                </div>
                <div class="checkbox-item" draggable="true" data-option="record">
                    <span class="drag-handle">⋮⋮</span>
                    <input type="checkbox" id="record">
                    <label for="record">Record(wins-losses)</label>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Misc</h2>
            <div class="input-group">
                <label for="sortBy">Sort by:</label>
                <select id="sortBy">
                    <option value="lastPlayed" selected>Last played</option>
                    <option value="mmr">MMR</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h2>Output</h2>
            <p style="margin-bottom: 15px; color: #ccc;">Live preview of the script output:</p>
            <div id="outputPreviewWarning" class="warning" style="display: none;">
                Output preview is too long (over 500 characters). Nightbot will truncate messages longer than 500 characters.
            </div>
            <div class="output-preview" id="outputPreview">
                Enter teamLegacyUids to see output preview
            </div>
        </div>

        <div class="output-section">
            <h3>Generated Script</h3>
            <div>
                <h4 style="color: #ffcc00; margin-bottom: 10px;">Raw form (for Nightbot dashboard):</h4>
                <div id="rawScriptWarning" class="warning" style="display: none;">
                    Raw script is too long (over 500 characters). Nightbot will not accept commands longer than 500 characters.
                </div>
                <div class="code-block" id="rawScript">
                    <button class="copy-btn" onclick="copyToClipboard('rawScript')">Copy</button>
                    <span id="rawScriptContent">Enter teamLegacyUids to generate script</span>
                </div>
            </div>
            <div>
                <h4 style="color: #ffcc00; margin-bottom: 10px;">Chat version (for stream chat):</h4>
                <div id="chatScriptWarning" class="warning" style="display: none;">
                    Chat script is too long (over 500 characters). Nightbot will not accept commands longer than 500 characters.
                </div>
                <div class="code-block" id="chatScript">
                    <button class="copy-btn" onclick="copyToClipboard('chatScript')">Copy</button>
                    <span id="chatScriptContent">Enter teamLegacyUids to generate script</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <h3>Information</h3>
            <p>
                <strong>Getting teamLegacyUids from SC2Pulse:</strong> To get team teamLegacyUids, visit SC2Pulse and add teams to the buffer by clicking on the green plus button to the right side of each team. Once you have added all desired teams to the buffer, you can click on the tool icon, and click on the "Chat MMR command" option on the menu. Alternatively, you can click on the clipboard icon and click on the "teamLegacyUid" option on the menu to copy the IDs to the clipboard.
            </p>
            <p>
                <strong>API Limitations:</strong> This tool uses the SC2 Pulse API, which may lag behind actual in-game results, especially for lower-level teams. The data may not always reflect the most current standings.
            </p>
            <p>
                <strong>Nightbot Character Limit:</strong> Nightbot has a 500-character limit for custom commands. If your generated script exceeds this limit, you'll need to reduce the number of options or teamLegacyUids. The script will still be generated and displayed, but Nightbot will reject commands that are too long.
            </p>
            <p>
                <strong>teamLegacyUid Limit:</strong> This tool accepts a maximum of 10 teamLegacyUids to prevent overly long commands and ensure reasonable response times.
            </p>
        </div>
    </div>

    <script>
        let draggedElement = null;
        let optionOrder = ['inGameName', 'mmr', 'topPercent', 'mode', 'region', 'record'];

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Check for teamLegacyUid query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const teamLegacyUid = urlParams.getAll('teamLegacyUid')?.join(',');
            if (teamLegacyUid) {
                document.getElementById('teamLegacyUids').value = teamLegacyUid;
            }
            
            const dataOptions = document.getElementById('dataOptions');
            let dropIndicator = null;
            
            dataOptions.addEventListener('dragstart', function(e) {
                draggedElement = e.target.closest('.checkbox-item');
                if (draggedElement) {
                    draggedElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            dataOptions.addEventListener('dragend', function(e) {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                
                // Clear all drop indicators
                clearDropIndicators();
            });

            dataOptions.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedElement) return;
                
                const dropInfo = getDropPosition(dataOptions, e.clientX, e.clientY);
                showDropIndicator(dropInfo);
            });

            dataOptions.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (!draggedElement) return;
                
                const dropInfo = getDropPosition(dataOptions, e.clientX, e.clientY);
                
                if (dropInfo.element && dropInfo.position === 'before') {
                    dataOptions.insertBefore(draggedElement, dropInfo.element);
                } else if (dropInfo.element && dropInfo.position === 'after') {
                    dataOptions.insertBefore(draggedElement, dropInfo.element.nextSibling);
                } else {
                    dataOptions.appendChild(draggedElement);
                }
                
                updateOptionOrder();
            });

            // Add event listeners for input changes
            document.getElementById('teamLegacyUids').addEventListener('input', generateScript);
            document.getElementById('sortBy').addEventListener('change', generateScript);
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', generateScript);
            });

            generateScript();
        });

        function getDropPosition(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.checkbox-item')];
            const otherDraggableElements = [...container.querySelectorAll('.checkbox-item:not(.dragging)')];
            
            let closestElement = null;
            let closestDistance = Number.POSITIVE_INFINITY;
            let position = 'after';
            
            otherDraggableElements.forEach(child => {
                const box = child.getBoundingClientRect();
                const centerX = box.left + box.width / 2;
                const centerY = box.top + box.height / 2;
                
                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestElement = child;
                }
            });
            
            const closestIx = draggableElements.indexOf(closestElement);
            const ix = draggableElements.indexOf(container.querySelector(':scope .dragging'));
            return { element: closestElement, position: ix < closestIx ? "after" : "before"};
        }

        function showDropIndicator(dropInfo) {
            clearDropIndicators();
            
            if (dropInfo.element) {
                if (dropInfo.position === 'before') {
                    dropInfo.element.classList.add('drop-before');
                } else {
                    dropInfo.element.classList.add('drop-after');
                }
            }
        }

        function clearDropIndicators() {
            document.querySelectorAll('.drop-before, .drop-after').forEach(el => {
                el.classList.remove('drop-before', 'drop-after');
            });
        }

        function updateOptionOrder() {
            const container = document.getElementById('dataOptions');
            const items = container.querySelectorAll('.checkbox-item');
            optionOrder = Array.from(items).map(item => item.dataset.option);
            generateScript();
        }

        function transformAndExecuteScript(rawScript, callback) {
            const outputPreview = document.getElementById('outputPreview');
            const outputPreviewWarning = document.getElementById('outputPreviewWarning');
            
            if (!rawScript || rawScript === 'Enter teamLegacyUids to generate script') {
                outputPreview.textContent = 'Enter teamLegacyUids to see output preview';
                outputPreview.className = 'output-preview';
                outputPreviewWarning.style.display = 'none';
                if (callback) callback(false);
                return;
            }

            // Show loading state
            outputPreview.textContent = 'Loading...';
            outputPreview.className = 'output-preview loading';
            outputPreviewWarning.style.display = 'none';

            try {
                // Remove $() wrapper and eval
                let script = rawScript.replace(/^\$\(eval\s+/, '').replace(/\)$/, '');
                
                // Extract URL from urlfetch
                const urlfetchMatch = script.match(/tt=\$\(urlfetch\s+json\s+([^)]+)\)/);
                if (!urlfetchMatch) {
                    throw new Error('Invalid script format');
                }
                
                const url = urlfetchMatch[1];
                
                // Remove the urlfetch part and get the rest
                const restOfScript = script.replace(/tt=\$\(urlfetch\s+json\s+[^)]+\);?/, '').replace('tt\.map', 'return tt\.map');
                
                // Transform to fetch and execute
                const transformedScript = `
                    fetch('${url}')
                        .then(resp => resp.json())
                        .then(tt => {
                            ${restOfScript}
                        })
                `;
                
                // Execute the transformed script
                eval(transformedScript)
                    .then(result => {
                        const resultText = result || 'No data returned';
                        outputPreview.textContent = resultText;
                        outputPreview.className = 'output-preview';
                        
                        // Check output preview length
                        if (resultText.length > 500) {
                            outputPreviewWarning.style.display = 'block';
                        } else {
                            outputPreviewWarning.style.display = 'none';
                        }

                        if (callback) callback(true);
                    })
                    .catch(error => {
                        console.error('Script execution error:', error);
                        outputPreview.textContent = `Error: ${error.message}`;
                        outputPreview.className = 'output-preview error';
                        outputPreviewWarning.style.display = 'none';
                        if (callback) callback(false);
                    });
                    
            } catch (error) {
                console.error('Script transformation error:', error);
                outputPreview.textContent = `Error: ${error.message}`;
                outputPreview.className = 'output-preview error';
                outputPreviewWarning.style.display = 'none';
                if (callback) callback(false);
            }
        }

        function generateScript() {
            const teamLegacyUidsInput = document.getElementById('teamLegacyUids');
            const teamLegacyUids = teamLegacyUidsInput.value.trim();
            const teamLegacyUidsError = document.getElementById('teamLegacyUidsError');

            // Hide/show sections based on legacyUids presence
            const sectionsToToggle = document.querySelectorAll('.section + .section, .output-section');

            if (!teamLegacyUids || !teamLegacyUidsInput.reportValidity()) {
                sectionsToToggle.forEach(section => section.classList.add('hidden'));
                document.getElementById('rawScriptContent').textContent = 'Enter teamLegacyUids to generate script';
                document.getElementById('chatScriptContent').textContent = 'Enter teamLegacyUids to generate script';
                teamLegacyUidsError.textContent = '';
                document.getElementById('rawScriptWarning').style.display = 'none';
                document.getElementById('chatScriptWarning').style.display = 'none';
                transformAndExecuteScript('');
                return;
            }

            sectionsToToggle.forEach(section => section.classList.remove('hidden'));
            // Validate number of teamLegacyUids
            const teamLegacyUidArray = teamLegacyUids.split(',').map(uid => uid.trim()).filter(uid => uid);
            if (teamLegacyUidArray.length > 10) {
                teamLegacyUidsError.textContent = 'Maximum 10 teamLegacyUids allowed. Please reduce the number of IDs.';
                document.getElementById('rawScriptContent').textContent = 'Too many teamLegacyUids provided';
                document.getElementById('chatScriptContent').textContent = 'Too many teamLegacyUids provided';
                document.getElementById('rawScriptWarning').style.display = 'none';
                document.getElementById('chatScriptWarning').style.display = 'none';
                transformAndExecuteScript('');
                return;
            }

            teamLegacyUidsError.textContent = '';

            const url = `https://sc2pulse.nephest.com/sc2/api/teams?last=&teamLegacyUid=${encodeURIComponent(teamLegacyUids)}`;
            
            let script = `tt=$(urlfetch json ${url});`;
            
            const sortBy = document.getElementById('sortBy').value;
            if (sortBy === 'lastPlayed') {
                script += `tt.forEach(t=>t.lastPlayed=new Date(t.lastPlayed));tt.sort((a,b)=>b.lastPlayed-a.lastPlayed);`;
            } else if (sortBy === 'mmr') {
                script += `tt.sort((a,b)=>b.rating-a.rating);`;
            }

            const mapParts = [];
            const activeOptions = optionOrder.filter(option => document.getElementById(option).parentElement.querySelectorAll("input:checked").length > 0);
            
            activeOptions.forEach(option => {
                switch(option) {
                    case 'inGameName':
                        const raceChecked = document.getElementById('race').checked;
                        const inGameNameChecked = document.getElementById('inGameName').checked;
                        let inGameNamePart = 't.members.map(m=>';
                        if(inGameNameChecked) {
                            inGameNamePart += '(m.character.tag||"?")';
                        }
                        if(raceChecked) {
                            inGameNamePart += (inGameNameChecked ? '+(" "+' : '(') + 'Object.keys(m.raceGames)[0].toLowerCase())';
                        }
                        inGameNamePart += ').join(", ")';
                        mapParts.push(inGameNamePart);
                        
                        break;
                    case 'mmr':
                        mapParts.push('t.rating+" MMR"');
                        break;
                    case 'topPercent':
                        mapParts.push('"top "+(t.regionRank/t.regionTeamCount*100).toFixed(2)+"%"');
                        break;
                    case 'mode':
                        mapParts.push('({201:"1v1",202:"2v2",203:"3v3",204:"4v4",206:"archon"}[t.queueType]||"unknown")');
                        break;
                    case 'region':
                        mapParts.push('t.region');
                        break;
                    case 'record':
                        mapParts.push('t.wins+"-"+t.losses');
                        break;
                }
            });

            if (mapParts.length > 0) {
                script += `tt.map(t=>[${mapParts.join(',')}].join(" ")).join("; ")`;
            } else {
                script += `"No data options selected"`;
            }

            const rawScript = `$(eval ${script})`;
            const chatScript = `!addcom !mmr ${rawScript}`;
            
            // Transform and execute the script for output preview first to validate
            transformAndExecuteScript(rawScript, function(success) {
               if (success) {
                   // Only show scripts if execution was successful
                   const rawScriptWarning = document.getElementById('rawScriptWarning');
                   const chatScriptWarning = document.getElementById('chatScriptWarning');

                   if (rawScript.length > 500) {
                       rawScriptWarning.style.display = 'block';
                   } else {
                       rawScriptWarning.style.display = 'none';
                   }

                   if (chatScript.length > 500) {
                       chatScriptWarning.style.display = 'block';
                   } else {
                       chatScriptWarning.style.display = 'none';
                   }

                   document.getElementById('rawScriptContent').textContent = rawScript;
                   document.getElementById('chatScriptContent').textContent = chatScript;
               } else {
                   // Hide scripts and warnings if execution failed
                   document.getElementById('rawScriptWarning').style.display = 'none';
                   document.getElementById('chatScriptWarning').style.display = 'none';
                   document.getElementById('rawScriptContent').textContent = 'Script validation failed - see output preview for details';
                   document.getElementById('chatScriptContent').textContent = 'Script validation failed - see output preview for details';
               }
            });
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textContent = element.querySelector('span').textContent;
            
            navigator.clipboard.writeText(textContent).then(function() {
                const btn = element.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#00ff00';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#ffcc00';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy text: ', err);
            });
        }
    </script>
</body>
</html>
